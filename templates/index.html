<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gmail Mail Grabber</title>
    <style>
      body { font-family: "Palatino Linotype", serif; background: #f2f0ea; margin: 0; padding: 0; }
      header { background: #2e3a2f; color: #fff; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
      main { max-width: 1600px; margin: 24px auto; padding: 0 16px 32px; }
      .card { background: #fff; border: 1px solid #e0d8cd; padding: 16px; margin-bottom: 16px; overflow-x: auto; }
      h1, h2 { margin: 0 0 12px; }
      label { display: block; margin: 8px 0 4px; }
      input { padding: 8px; border: 1px solid #c9c3b8; }
      button, a.button { padding: 8px 12px; background: #6d4c41; color: #fff; border: none; text-decoration: none; cursor: pointer; display: inline-block; }
      table { width: 100%; border-collapse: collapse; min-width: 800px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; word-break: break-word; }
      td { max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; }
      .stat { font-size: 14px; color: #555; }
      .top-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      .progress-bar { width: 100%; height: 20px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 4px 0; }
      .progress-fill { height: 100%; background: #6d4c41; transition: width 0.3s ease; }
      .status-queued { color: #666; }
      .status-running { color: #2196F3; font-weight: bold; }
      .status-completed { color: #4CAF50; font-weight: bold; }
      .status-error { color: #f44336; font-weight: bold; }
      .status-auth_required { color: #ff9800; font-weight: bold; }
      .error-message { color: #f44336; font-size: 12px; margin-top: 4px; }
      .progress-text { font-size: 12px; color: #666; margin-top: 2px; }
      .table-container { overflow-x: auto; }
      .action-btn { padding: 6px 10px; background: #6d4c41; color: #fff; border: none; cursor: pointer; font-size: 12px; border-radius: 3px; }
      .action-btn:hover { background: #5a3d33; }
      .action-btn:disabled { background: #ccc; cursor: not-allowed; }
      .action-buttons { display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; }
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto; }
      .modal-content { background: #fff; margin: 2% auto; padding: 20px; width: 90%; max-width: 1000px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0d8cd; padding-bottom: 10px; }
      .modal-close { font-size: 28px; font-weight: bold; cursor: pointer; color: #999; }
      .modal-close:hover { color: #333; }
      .accordion { margin-bottom: 10px; }
      .accordion-header { background: #f7f5f2; padding: 12px 16px; cursor: pointer; border: 1px solid #e0d8cd; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
      .accordion-header:hover { background: #eee9e3; }
      .accordion-header.active { background: #e0d8cd; }
      .accordion-title { font-weight: bold; flex: 1; }
      .accordion-meta { font-size: 12px; color: #666; margin-left: 10px; }
      .accordion-arrow { font-size: 12px; transition: transform 0.2s; }
      .accordion-arrow.open { transform: rotate(90deg); }
      .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; border: 1px solid #e0d8cd; border-top: none; border-radius: 0 0 4px 4px; }
      .accordion-content.open { max-height: 2000px; }
      .accordion-body { padding: 16px; background: #fff; }
      .message-detail { margin-bottom: 12px; }
      .message-label { font-weight: bold; color: #6d4c41; display: inline-block; min-width: 100px; }
      .message-value { color: #333; }
      .message-body { background: #f9f9f9; padding: 12px; border-radius: 4px; margin-top: 8px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
      .loading { text-align: center; padding: 20px; color: #666; }
      .no-messages { text-align: center; padding: 40px; color: #999; }
      .attachment-item { display: inline-block; background: #e8e4df; padding: 4px 8px; margin: 2px; border-radius: 3px; font-size: 12px; }
      @media (max-width: 768px) {
        header { padding: 12px 16px; }
        .top-actions { flex-direction: column; align-items: flex-start; width: 100%; }
        main { padding: 0 8px 16px; }
        .modal-content { width: 95%; margin: 5% auto; padding: 15px; }
      }
    </style>
    <script>
      // Auto-refresh page every 3 seconds if there are active batches
      document.addEventListener('DOMContentLoaded', function() {
        const hasActiveBatches = document.querySelectorAll('.status-queued, .status-running').length > 0;
        if (hasActiveBatches) {
          setTimeout(function() {
            window.location.reload();
          }, 3000);
        }

        // Modal functionality
        const modal = document.getElementById('messagesModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeBtn = document.querySelector('.modal-close');
        const viewMessagesBtns = document.querySelectorAll('.view-messages-btn');

        // Open modal and load messages
        viewMessagesBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            const batchId = this.getAttribute('data-batch-id');
            const batchRange = this.getAttribute('data-batch-range');

            modalTitle.textContent = 'Messages for Batch #' + batchId + ' (' + batchRange + ')';
            modalBody.innerHTML = '<div class="loading">Loading messages...</div>';
            modal.style.display = 'block';

            // Fetch messages
            fetch('/batch/' + batchId + '/messages')
              .then(response => response.json())
              .then(data => {
                renderMessages(data.messages);
              })
              .catch(error => {
                modalBody.innerHTML = '<div class="no-messages">Error loading messages: ' + error.message + '</div>';
              });
          });
        });

        // Close modal
        closeBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });

        // Render messages as accordion
        function renderMessages(messages) {
          if (!messages || messages.length === 0) {
            modalBody.innerHTML = '<div class="no-messages">No messages found for this batch.</div>';
            return;
          }

          let html = '';
          messages.forEach((msg, index) => {
            const subject = msg.subject || '(No Subject)';
            const sender = msg.sender || 'Unknown';
            const recipient = msg.recipient || 'Unknown';
            const date = msg.formatted_date || 'N/A';
            const snippet = msg.snippet || '';
            const bodyText = msg.body_text || '';
            const bodyHtml = msg.body_html || '';
            const attachments = msg.attachments || [];

            html += `
              <div class="accordion">
                <div class="accordion-header" data-index="${index}">
                  <span class="accordion-title">${escapeHtml(subject)}</span>
                  <span class="accordion-meta">From: ${escapeHtml(sender)} | ${date}</span>
                  <span class="accordion-arrow">â–¶</span>
                </div>
                <div class="accordion-content" data-index="${index}">
                  <div class="accordion-body">
                    <div class="message-detail">
                      <span class="message-label">Subject:</span>
                      <span class="message-value">${escapeHtml(subject)}</span>
                    </div>
                    <div class="message-detail">
                      <span class="message-label">From:</span>
                      <span class="message-value">${escapeHtml(sender)}</span>
                    </div>
                    <div class="message-detail">
                      <span class="message-label">To:</span>
                      <span class="message-value">${escapeHtml(recipient)}</span>
                    </div>
                    <div class="message-detail">
                      <span class="message-label">Date:</span>
                      <span class="message-value">${date}</span>
                    </div>
                    ${snippet ? `<div class="message-detail">
                      <span class="message-label">Snippet:</span>
                      <span class="message-value">${escapeHtml(snippet)}</span>
                    </div>` : ''}
                    ${attachments.length > 0 ? `<div class="message-detail">
                      <span class="message-label">Attachments:</span>
                      <div class="message-value">
                        ${attachments.map(att => `<span class="attachment-item">${escapeHtml(att.filename)} (${formatBytes(att.size)})</span>`).join('')}
                      </div>
                    </div>` : ''}
                    ${bodyText || bodyHtml ? `<div class="message-detail">
                      <span class="message-label">Message Body:</span>
                      <div class="message-body">${escapeHtml(bodyText || bodyHtml)}</div>
                    </div>` : ''}
                  </div>
                </div>
              </div>
            `;
          });

          modalBody.innerHTML = html;

          // Add accordion toggle functionality
          document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', function() {
              const index = this.getAttribute('data-index');
              const content = document.querySelector(`.accordion-content[data-index="${index}"]`);
              const arrow = this.querySelector('.accordion-arrow');

              // Toggle open class
              const isOpen = content.classList.contains('open');

              if (isOpen) {
                content.classList.remove('open');
                this.classList.remove('active');
                arrow.classList.remove('open');
              } else {
                content.classList.add('open');
                this.classList.add('active');
                arrow.classList.add('open');
              }
            });
          });
        }

        // Utility functions
        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        function formatBytes(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
      });
    </script>
  </head>
  <body>
    <header>
      <div>Gmail Mail Grabber - {{ user['username'] }}</div>
      <div class="top-actions">
        <a class="button" href="{{ url_for('profile') }}">Profile & API Key</a>
        {% if not user['gmail_connected'] %}
        <a class="button" href="{{ url_for('auth_google') }}">Connect Google</a>
        {% endif %}
        <a class="button" href="{{ url_for('logout') }}">Logout</a>
      </div>
    </header>
    <main>
      <div class="card">
        <h2>Fetch Emails</h2>
        <form method="post" action="{{ url_for('fetch_emails') }}">
          <div class="row">
            <div>
              <label>Start date</label>
              <input type="date" name="start_date" />
            </div>
            <div>
              <label>End date</label>
              <input type="date" name="end_date" />
            </div>
          </div>
          <div style="margin-top: 12px;">
            <button type="submit">Fetch</button>
          </div>
        </form>
        <p class="stat">If no dates are selected, it fetches today&apos;s emails.</p>
      </div>

      <div class="card">
        <h2>Stats</h2>
        <p class="stat">Completed batches: {{ stats['total_batches'] or 0 }}</p>
        <p class="stat">Total messages stored: {{ stats['total_messages'] or 0 }}</p>
      </div>

      <div class="card">
        <h2>Recent Batches</h2>
        <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Gmail Account</th>
              <th>Range</th>
              <th>Status & Progress</th>
              <th>Messages</th>
              <th>File</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for b in batches %}
            <tr>
              <td>{{ b['id'] }}</td>
              <td style="font-size: 12px;">{{ b['gmail_account'] or 'N/A' }}</td>
              <td>{{ b['start_date'] }} to {{ b['end_date'] }}</td>
              <td>
                <span class="status-{{ b['status'] }}">{{ b['status'] }}</span>
                {% if b['status'] == 'running' %}
                  <div class="progress-bar">
                    {% set progress = (b['processed_messages'] / b['estimated_total'] * 100) if b['estimated_total'] > 0 else 0 %}
                    <div class="progress-fill" style="width: {{ progress }}%"></div>
                  </div>
                  <div class="progress-text">
                    {{ b['processed_messages'] }} / {{ b['estimated_total'] }}
                    ({{ "%.1f"|format(progress) }}%)
                  </div>
                {% elif b['status'] == 'queued' %}
                  <div class="progress-text">Waiting to start...</div>
                {% elif b['status'] == 'error' and b['error_message'] %}
                  <div class="error-message">{{ b['error_message'] }}</div>
                {% elif b['status'] == 'auth_required' %}
                  <div class="error-message">Google authentication required</div>
                {% endif %}
              </td>
              <td>{{ b['total_messages'] }}</td>
              <td>{{ b['file_path'] or '-' }}</td>
              <td>{{ b['created_at'] }}</td>
              <td>
                <div class="action-buttons">
                  {% if b['status'] == 'completed' and b['total_messages'] > 0 %}
                    <button class="action-btn view-messages-btn" data-batch-id="{{ b['id'] }}" data-batch-range="{{ b['start_date'] }} to {{ b['end_date'] }}">
                      View Messages
                    </button>
                  {% else %}
                    <button class="action-btn" disabled>-</button>
                  {% endif %}
                  <form method="post" action="{{ url_for('refetch_batch', batch_id=b['id']) }}" style="display: inline;">
                    <button class="action-btn" type="submit" {% if b['status'] == 'running' or b['status'] == 'queued' %}disabled{% endif %}>
                      Refetch
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      </div>
    </main>

    <!-- Messages Modal -->
    <div id="messagesModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Batch Messages</h2>
          <span class="modal-close">&times;</span>
        </div>
        <div id="modalBody">
          <div class="loading">Loading messages...</div>
        </div>
      </div>
    </div>
  </body>
</html>
